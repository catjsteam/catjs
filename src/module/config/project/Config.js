var _typedas=require("typedas"),_Action=require("./Action.js"),_Extension=require("./Extension.js"),_Task=require("./Task.js"),_global=catrequire("cat.global"),_log=_global.log(),_utils=catrequire("cat.utils"),_props=catrequire("cat.props"),_fs=require("fs.extra"),_path=require("path"),Config=function(t){function n(t){function n(t){var n=h[t];n&&n.forEach(function(n){n&&(n.name||_log.error("[CAT Config] Missing property 'name' for action configuration "),_[t]&&(_[t][n.name]=n))})}t?n(t):(n("actions"),n("tasks"),n("extensions"))}function o(){function t(t){var n,r;t&&(i=_utils.resolveObject(y,t),o=_path.normalize([e,i].join("/")),o&&(_fs.existsSync(o)?_log.debug(_props.get("cat.project.resource.exists").format("[cat config]",o)):_utils.mkdirSync(o),"source"===t&&(n=_path.join(o,"common"),_fs.existsSync(n)||(_utils.mkdirSync(n),_utils.copySync(_path.join(p.path,"src/module/project/src/common/README.txt"),_path.join(n,"README.txt"))),r=_path.join(o,"config"),_fs.existsSync(r)||_utils.mkdirSync(r),_utils.copySync(_path.join(p.path,"src/module/project/src/config/testdata.json"),_path.join(r,"testdata.json"))),d.info[t]=o))}function n(t){t.forEach(function(t){t&&(d.info[t]=y[t])})}var o,i,e=p.working.path;t("source"),t("target"),n(["host","port","appserver","apppath","cattarget","analytics","runner"])}function i(t){c=t?t:y.tasks,c&&_typedas.isArray(c)?c.forEach(function(t){t&&(t.name&&_.tasks[t.name]||f.push(new _Task({data:t,emitter:l,global:y,catconfig:d})))}):_log.warning("[CAT Config] Missing 'tasks' configuration section")}function e(t){a=t?t:y.plugins,a&&_typedas.isArray(a)?a.forEach(function(t){t&&(t.name&&_.actions[t.name]||g.push(new _Action({data:t,emitter:l,global:y,catconfig:d})))}):_log.warning("[CAT Config] Missing 'plugins' configuration section")}function r(t){var n=t?t:y.extensions||y.dependencies;n&&_typedas.isArray(n)?n.forEach(function(t){t&&(t.name&&_.extensions[t.name]||u.push(new _Extension({data:t,emitter:l,global:y,catconfig:d})))}):_log.warning("[CAT Config] Missing 'dependencies' configuration section")}function s(){i(),e(),r(),n(),o()}var a,c,p=_global.get("home"),g=[],f=[],u=[],h={actions:g,tasks:f,extensions:u},_={tasks:{},actions:{},extensions:{}},l=t.emitter,y=t.data,d=this;return y?(this.name=y.name,this.base=y.base,this.actions=g,this.extensions=u,this.tasks=f,this.pluginPaths=[],this.info={},this._get=function(t){var n;return"me"===t?n=d:"map"===t&&(n=_),n},this._appendEntity=function(t,o){"plugins"===t?(e(o),n("actions")):"extensions"===t||"dependencies"===t?(r(o),n("extensions")):"tasks"===t&&(i(o),n("tasks"))},s(),this):void _utils.error(_props.get("cat.error.config").format("[CAT Config]"))};Config.prototype.destroy=function(){},Config.prototype.appendEntity=function(t,n){this._appendEntity(t,n)},Config.prototype.getTask=function(t){var n=this._get("map");return t&&n.tasks?n.tasks[t]:void 0},Config.prototype.getAction=function(t){var n,o=this._get("map");return t&&o.actions?(n=o.actions[t],n||(n=this.pluginLookup(t),n&&this._appendEntity("plugins",[{name:t,type:t}]),n=o.actions[t]),n):void 0},Config.prototype.getExtension=function(t){var n=this._get("map");return t&&n.extensions?n.extensions[t]:void 0},Config.prototype.addPluginLocations=function(t){var n=this._get("me");_typedas.isArray(t)?n.pluginPaths=n.pluginPaths.concat(t):_utils.error(_props.get("cat.arguments.type").format("[cat config]","Array"))},Config.prototype.pluginLookup=function(t){for(var n,o,i,e=this._get("me"),r=e.pluginPaths,s=0,a=r.length;a>s;s++)if(i=r[s])try{if(o=[i,t,".js"].join(""),o=_path.normalize(o),_fs.existsSync(o)){n=require(o);break}}catch(c){_utils.error(_props.get("cat.error.require.module").format("[cat config]",o))}return n},Config.prototype.getTargetFolder=function(){return _path.join(_global.get("home").working.path,"target",this.name)},Config.prototype.getInfo=function(t){var n=_utils.resolveObject(this.info,t);return n||_log.warning(_props.get("cat.error.config.missing").format("[cat config]",t)),n},Config.prototype.setInfo=function(t,n){return this.info[t]=n},Config.prototype.getPort=function(){var t=this.getInfo("appserver.port")||this.getInfo("port");return t||"8089"},Config.prototype.getRunner=function(){var t=this.getInfo("runner");return t?t:void 0},Config.prototype.getHost=function(){return this.getInfo("appserver.host")||this.getInfo("host")},Config.prototype.getProtocol=function(){var t=this.getInfo("appserver.protocol")||this.getInfo("protocol");return t||"http://"},Config.prototype.getAddress=function(){var t,n,o;return t=this.getHost(),n=this.getPort(),o=this.getProtocol(),t&&n?[o,"://",t,":",n].join(""):void _log.warning("[CAT project config] Missing configuration properties: 'host' and/or 'port' (see catproject.json)")},Config.prototype.update=function(t){var n,o;if(t&&"data"in t&&(o=t.data))for(n in o)this._appendEntity(n,o[n])},module.exports=Config;