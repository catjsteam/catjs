var _typedas=require("typedas"),_Action=require("./Action.js"),_Extension=require("./Extension.js"),_Task=require("./Task.js"),_global=catrequire("cat.global"),_log=_global.log(),_utils=catrequire("cat.utils"),_props=catrequire("cat.props"),_fs=require("fs.extra"),_path=require("path"),Config=function(t){function o(t){function o(t){var o=h[t];o&&o.forEach(function(o){o&&(o.name||_log.error("[CAT Config] Missing property 'name' for action configuration "),l[t]&&(l[t][o.name]=o))})}t?o(t):(o("actions"),o("tasks"),o("extensions"))}function n(){function t(t){var o;t&&(i=_utils.resolveObject(m,t),n=_path.normalize([e,i].join("/")),n&&(_fs.existsSync(n)?_log.debug(_props.get("cat.project.resource.exists").format("[cat config]",n)):_utils.mkdirSync(n),"source"===t&&(o=_path.join(n,"common"),_fs.existsSync(o)||(_utils.mkdirSync(o),_utils.copySync(_path.join(c.path,"src/module/project/src/common/README.txt"),_path.join(o,"README.txt")))),y.info[t]=n))}function o(t){t.forEach(function(t){t&&(y.info[t]=m[t])})}var n,i,e=c.working.path;t("source"),t("target"),o(["host","port","appserver","apppath"])}function i(t){p=t?t:m.tasks,p&&_typedas.isArray(p)?p.forEach(function(t){t&&(t.name&&l.tasks[t.name]||f.push(new _Task({data:t,emitter:_,global:m,catconfig:y})))}):_log.warning("[CAT Config] Missing 'tasks' configuration section")}function e(t){a=t?t:m.plugins,a&&_typedas.isArray(a)?a.forEach(function(t){t&&(t.name&&l.actions[t.name]||g.push(new _Action({data:t,emitter:_,global:m,catconfig:y})))}):_log.warning("[CAT Config] Missing 'plugins' configuration section")}function r(t){var o=t?t:m.extensions||m.dependencies;o&&_typedas.isArray(o)?o.forEach(function(t){t&&(t.name&&l.extensions[t.name]||u.push(new _Extension({data:t,emitter:_,global:m,catconfig:y})))}):_log.warning("[CAT Config] Missing 'dependencies' configuration section")}function s(){i(),e(),r(),o(),n()}var a,p,c=_global.get("home"),g=[],f=[],u=[],h={actions:g,tasks:f,extensions:u},l={tasks:{},actions:{},extensions:{}},_=t.emitter,m=t.data,y=this;return m?(this.name=m.name,this.base=m.base,this.actions=g,this.extensions=u,this.tasks=f,this.pluginPaths=[],this.info={},this._get=function(t){var o;return"me"===t?o=y:"map"===t&&(o=l),o},this._appendEntity=function(t,n){"plugins"===t?(e(n),o("actions")):"extensions"===t||"dependencies"===t?(r(n),o("extensions")):"tasks"===t&&(i(n),o("tasks"))},s(),this):void _utils.error(_props.get("cat.error.config").format("[CAT Config]"))};Config.prototype.destroy=function(){},Config.prototype.appendEntity=function(t,o){this._appendEntity(t,o)},Config.prototype.getTask=function(t){var o=this._get("map");return t&&o.tasks?o.tasks[t]:void 0},Config.prototype.getAction=function(t){var o,n=this._get("map");return t&&n.actions?(o=n.actions[t],o||(o=this.pluginLookup(t),o&&this._appendEntity("plugins",[{name:t,type:t}]),o=n.actions[t]),o):void 0},Config.prototype.getExtension=function(t){var o=this._get("map");return t&&o.extensions?o.extensions[t]:void 0},Config.prototype.addPluginLocations=function(t){var o=this._get("me");_typedas.isArray(t)?o.pluginPaths=o.pluginPaths.concat(t):_utils.error(_props.get("cat.arguments.type").format("[cat config]","Array"))},Config.prototype.pluginLookup=function(t){for(var o,n,i,e=this._get("me"),r=e.pluginPaths,s=0,a=r.length;a>s;s++)if(i=r[s])try{if(n=[i,t,".js"].join(""),n=_path.normalize(n),_fs.existsSync(n)){o=require(n);break}}catch(p){_utils.error(_props.get("cat.error.require.module").format("[cat config]",n))}return o},Config.prototype.getTargetFolder=function(){return _path.join(_global.get("home").working.path,"target",this.name)},Config.prototype.getInfo=function(t){var o=_utils.resolveObject(this.info,t);return o||_log.warning(_props.get("cat.error.config.missing").format("[cat config]",t)),o},Config.prototype.setInfo=function(t,o){return this.info[t]=o},Config.prototype.getPort=function(){var t=this.getInfo("appserver.port")||this.getInfo("port");return t||"8089"},Config.prototype.getHost=function(){return this.getInfo("appserver.host")||this.getInfo("host")},Config.prototype.getProtocol=function(){var t=this.getInfo("appserver.protocol")||this.getInfo("protocol");return t||"http://"},Config.prototype.getAddress=function(){var t,o,n;return t=this.getHost(),o=this.getPort(),n=this.getProtocol(),t&&o?[n,"://",t,":",o].join(""):void _log.warning("[CAT project config] Missing configuration properties: 'host' and/or 'port' (see catproject.json)")},Config.prototype.update=function(t){var o,n;if(t&&"data"in t&&(n=t.data))for(o in n)this._appendEntity(o,n[o])},module.exports=Config;