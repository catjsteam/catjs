var _fs=require("fs.extra"),_path=require("path"),_lineReader=require("line-reader"),_global=catrequire("cat.global"),_log=_global.log(),_mdata=catrequire("cat.mdata"),_Scrap=catrequire("cat.common.scrap"),_utils=catrequire("cat.utils"),_tplutils=catrequire("cat.tpl.utils"),_props=catrequire("cat.props"),_basePlugin=require("./../Base.js"),_project=catrequire("cat.project"),_beautify=require("js-beautify").js_beautify,_extutils=catrequire("cat.ext.utils");module.exports=_basePlugin.ext(function(){var e,t=this,n=_Scrap.getScrapEnum(),a=function(a,i){function r(e,a){var r=[],s=t._project.getInfo("target");return e.forEach(function(e){var t,a,c,o,l=e.$getEngine(),u=e.get("arguments");(l===n.engines.JS||l===n.engines.HTML_EMBED_JS)&&(t=e.get("run@"),c=_extutils.getCATInfo({scrap:e,file:i,basepath:s}).pkgName,e.set("pkgName",c),c=[c,"cat"].join("$$"),o=["{ scrap:",JSON.stringify(e.serialize()),"}"].join(""),t&&(a=_tplutils.template({name:"scrap/_func_manager",data:{name:c,runat:t}})),a&&r.push(a),r.push(_tplutils.template({name:"scrap/_func_declare",data:{name:c,scrap:o,type:"scrap"}})),r.push(_tplutils.template({name:"scrap/_func",data:{name:c,arguments:u?u.join(","):void 0,output:e.generate()}})))}),{output:r.join(""),file:_extutils.getCATInfo({file:a}).file}}function s(e,a){var r=[],s=t._project.getInfo("target");return e.forEach(function(e){var t,a,c=e.$getEngine();(c===n.engines.JS||c===n.engines.HTML_EMBED_JS)&&(a=_extutils.getUserInfo({scrap:e,file:i,basepath:s}).pkgName,e.set("pkgName",a),t=_tplutils.template({name:"scrap/_func_user",data:{name:_extutils.getUserInfo({scrap:e,file:i,basepath:s}).pkgName,func:""}}),r.push(t))}),{output:r.join(""),file:_extutils.getUserInfo({file:a}).file}}function c(e,t,n){function a(e){var t,n,a;return e&&(a=_path.basename(e),n=_path.extname(e),a=[a.split(".")[0],"js"].join("."),".js"!==n&&(t=_path.dirname(e),e=_path.join(t,a))),e}var i=t.call(this,e,n),r=i.output;if(r){r=_beautify(r,{indent_size:2});try{i.file=a(i.file),_fs.writeFileSync(i.file,r),_log.debug(_props.get("cat.source.project.file.create").format("[inject ext]",n))}catch(s){_utils.error(_props.get("cat.error").format("[inject ext]",s))}}}function o(){}var l,u,p=e.project&&e.project.basepath?_utils.getRelativePath(i,e.project.basepath):void 0;o(),l=_path.join(_project.getInfo("source"),p),u=_path.dirname(l),u&&(_fs.existsSync(u)||_utils.mkdirSync(u)),c(a,r,l),_fs.existsSync(l)||c(a,s,l)},i=function(e,t,a){function i(e){var t,a=(c.length,0);return c.forEach(function(i){function c(){var t,n;d&&d.start&&(t=[d.start.line,d.start.col],n=[d.end.line,d.end.col],s===t[0]&&(e=[e.substring(0,t[1]),e.substring(n[1])].join("")))}function o(){return p=m.generateCtxArguments(),f=[["{ scrap:",JSON.stringify(m.serialize()),"}"].join("")],p&&p.length>0&&(f=f.concat(p)),d&&c(),g?e:(_===n.engines.JS?u=_tplutils.template({name:"scrap/_cat_call",data:{param1:f.join(",")}}):_===n.engines.HTML_EMBED_JS?u=_tplutils.template({name:"scrap/_cat_embed_js",data:{param1:f.join(",")}}):_===n.engines.HTML_IMPORT_JS?u=m.generate():_===n.engines.HTML_EMBED_INSERT&&(u=m.generate()),u=_utils.prepareCode(u)||"",e=t?[e.substring(0,t.end.col),u,e.substring(t.end.col,e.length)].join(""):[e.substring(0,i.col),u,e.substring(i.col,e.length)].join(""),t=t?{start:{line:s,col:t.end.col},end:{line:s,col:t.end.col+u.length}}:{start:{line:s,col:i.col},end:{line:s,col:i.col+u.length}},void m.set("injectinfo",t))}function l(){var t,a={prefix:"/*",suffix:"*/"};return m.$getBehavior()?(_===n.engines.JS?t=a:_===n.engines.HTML_EMBED_JS&&(t=a),g.apply({lines:r,line:e,row:s,mark:t})):void 0}var u,p,f,_,g,m=i.scrap,d=m.get("injectinfo"),h=!1;m&&(g=m.get("replaceinfo")),(s===i.line||g)&&(h=s===i.line,_=m.$getEngine(),l(),h&&o()),a++}),e}var r=[],s=1,c=[];e.forEach(function(e){var t=e.get("commentinfo");t&&c.push({col:t.end.col,line:t.end.line,scrap:e})}),_lineReader.eachLine(t,function(e){e=i(e),r.push(e+"\n"),s++}).then(function(){try{_fs.writeFileSync(t,r.join("")),_log.debug(_props.get("cat.mdata.write").format("[inject ext]"))}catch(e){_utils.error(_props.get("cat.error").format("[inject ext]",e))}a.call(this)})},r=function(e,t,n){var r=t;r&&_fs.existsSync(r)&&(a(e,r),i(e,r,function(){n.call(this)}))},s={init:function(e,n){t.initialize(e,n)},watch:function(){console.log("inject");var e=t.getEmitter();e.emit("job.done",{status:"done"})},apply:function(n){function a(e){var t,n,l,u,p=[];if(e){if(u=i[e],p=[],u)for(t in u)n=u[t],n&&(l=new _Scrap.clazz(n),l&&p.push(l));_Scrap.apply({scraps:p}),r(p,e,function(){c++,a(s[c]),_Scrap.apply({scraps:p,apply:!1})})}else o.emit("job.done",{status:"done"})}var i,s=[],c=-1,o=t.getEmitter();t.apply(n),_mdata&&_mdata.readAsync(function(){var t;if(this.data&&(e=JSON.parse(this.data))){if(i=e.files)for(t in i)t&&s.push(t);s&&s.length>0&&(c=0,a(s[c]))}})}};return s});