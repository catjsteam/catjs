function getColorIndex(e){return void 0!==e&&"undefined"!=typeof _colorCell[e]?_colorCell[e]:(_colorIndex++,_colorIndex>_colorsArray.length-1&&(_colorIndex=0),void 0!==e&&(_colorCell[e]=_colorIndex),_colorIndex)}function deleteColor(e){void 0!==e&&"undefined"!=typeof _colorCell[e]&&delete _colorCell[e]}function init(){_colors=require("colors");var e,t,r,o,s=require("path");if(_catcli)if(r=_catcli.getProject())try{o=r.getInfo("source"),e=s.join(o,"/config/cat.json")}catch(a){_log.error("[CAT server (assert module)] Failed to load cat.json test project, No CAT test project is available.",a)}else _log.error("[CAT server (assert module)] Failed to load cat.json test project, No CAT project is available.");t=_fs.readFileSync(e,"utf8"),_testconfig=JSON.parse(t)}function isManagerRunMode(){return"tests"===_testconfig["run-mode"]}function readTestConfig(e){var t,r,o,s,a,n={};if(isManagerRunMode()&&(e||_log.warning("[CAT] Current scenario argument is required for run-mode: tests "),r=_testconfig.scenarios))if(o=r[e])if(s=o.tests)for(a=s.length,t=0;a>t;t++)s[t].wasRun=!1,n[s[t].name]=s[t];else _log.warning("[CAT] No valid tests was found for scenario '"+e+"' ");else _log.warning("[CAT] No valid test scenario '"+e+"' was found");return n}function ReportCreator(e,t,r){this._fileName=e,this._testConfigMap=readTestConfig(r),this._hasFailed=!1,this._testsuite=_jmr.create({type:"model.testsuite",data:{name:t}})}var _jmr=require("test-model-reporter"),_global=catrequire("cat.global"),_log=_global.log(),_reportCreator={},_catcli=catrequire?catrequire("cat.cli"):null,_fs=require("fs"),_checkIfAlive,_testconfig,_colors,_colorsArray=["blue","yellow","cyan","magenta","grey","green"],_colorCell={},_colorIndex=-1;ReportCreator.prototype.getTestConfigMap=function(){return this._testConfigMap},ReportCreator.prototype.addTestCase=function(e){function t(e){var t;c&&(t="["+m+"] "+e,console.info(t.current),_log.info(t))}function r(){var e=_jmr.create({type:"model.testcase",data:{time:(new Date).toUTCString()}});return e.set("name",f+d),"failure"===u&&(s=_jmr.create({type:"model.failure",data:{message:_,type:u}}),e.add(s)),e}function o(){C._testsuite.add(r()),n=C._testsuite.compile(),_fs.existsSync(C._fileName)&&_fs.unlinkSync(C._fileName),_jmr.write(C._fileName,n)}var s,a,n,i,l,c,d,u,f,_,p,g,m,C=this;d=e.testName,u=e.status,f=e.phantomStatus,_=e.message,p=e.reports,g=e.error,m=e.id,l=1===p.junit,c=1===p.console,_colors.setTheme({current:_colorsArray[getColorIndex(m)]}),isManagerRunMode()&&this._testConfigMap[d]&&(this._testConfigMap[d].wasRun=!0),"End"!==u?(l&&o(),i="failure"===u?"✖":"✓","failure"===u&&(this._hasFailed=!0),a=i+"Test "+d+" "+_,t(a)):(g?(_colors.setTheme({current:"red"}),s="Test end with error: "+g,s="======== Test End - "+s+" ========"):(s=this._hasFailed?"failed":"succeeded",s="======== Test End - "+s+" ========"),t(s),deleteColor(m))},void 0===_jmr&&_log.info("Test Unit Reporter is not supported, consider adding it to the .catproject dependencies"),init(),exports.result=function(e,t){var r,o=e.query,s=o.testName,a=o.message,n=o.error,i=o.status,l=o.reports,c=o.scenario,d=o.type,u=o.hasPhantom,f=o.id,_=1e3*(_testconfig["test-failure-timeout"]||30),p=[];l&&(p=l.split(","),l={},p.forEach(function(e){e&&(l[e]=1)})),clearTimeout(_checkIfAlive),"End"!==i&&(_checkIfAlive=setTimeout(function(){_reportCreator==={}?(_reportCreator.notest=new ReportCreator("notestname.xml","notest",c),_log.info("[CAT] No asserts received, probably a network problem, failing the rest of the tests ")):_log.info("[CAT] Tests stopped reporting, probably a network problem, failing the rest of the tests");for(var e in _reportCreator){var t=_reportCreator[e].getTestConfigMap();for(var r in t)_log.info(t[r]),t[r].wasRun||_reportCreator[e].addTestCase({testName:t[r].name,status:"failure",phantomStatus:"",message:"failed due to network issue",reports:l,error:n,id:f})}},_)),_log.info("requesting "+s+a+i),t.setHeader("Content-Type","text/javascript;charset=UTF-8"),t.send({testName:s,message:a,status:i});var g="true"===u?"phantom":"";r="./"+d+"-"+g+f+".xml",_reportCreator[f]||(_reportCreator[f]=new ReportCreator(r,d+f,c)),_reportCreator[f].addTestCase({testName:s,status:i,phantomStatus:g,message:a,reports:l,error:n,id:f})};