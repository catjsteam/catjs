var _flow,_prompt=require("prompt"),_jsutils=require("js.utils"),CAT=function(){function e(e,t){var r,i;e=e.toString(),e=e.toLowerCase(),m&&(r=m.externalConfig.project,i=r.getTask(e),i?(_flow.log({msg:[" > Open Task: ",JSON.stringify(i),"watch: "+(t?!0:!1)].join(" ")}),t&&m.watch(t),i.apply(m)):h.log("error","[CAT] No valid task named: '"+g+"', validate your cat's project configuration (catproject.json)"))}function t(r){u.on("task.done",function(){_flow.log({msg:[" Close Task: ",g[w]].join(" ")}),w++,w<g.length&&(u.removeAllListeners("task.done"),t(r))}),e(g[w],r)}var r,i,o,n,a,s,p,c,u,l,d,f,h,g,m,w=0;return function(){i=require("string-format"),s=require("path"),c=require("events"),u=new c.EventEmitter,l=function(e){return e&&e.home||{home:{path:"."}}}}(),{init:function(e){var t,i,s=this;!function(e){t=l(e),i=t.path,r=catrequire("cat.global"),o=r.log(),n=catrequire("cat.project"),a=catrequire("cat.config"),p=catrequire("cat.props"),h=catrequire("cat.utils"),r.set("home",t),f=catrequire("cat.cache"),f.set("pid",process.pid)}(e),p.init(function(t,r){return t?void o.error("[Properties] "+t):(global.CAT.props=r,void s.apply.call(s,e))})},watch:function(e){e&&(w=0,t(e))},apply:function(e){function i(){if(!e)return void 0;var t,i=r.get("home");i&&i.working&&(t=i.working.path),j=e.kill||j,y=e.watch||y,q="undefined"==typeof e.init?void 0:e.init||"cat",g=e.task,c=e.grunt,l=e,v=e.path||t,v&&o.debug("[CAT] Initial, current location: "+s.resolve(v)),o.debug("[CAT] Initial, command line arguments: "+JSON.stringify(e)),process.on("uncaughtException",function(e){console.error(e),process.exit(1)}),process.on("exit",function(){f.removeByKey("pid",process.pid)}),process.on("SIGINT",function(){process.exit(1)})}function p(){var e,i,p,l,k,C=r.get("home"),A=function(e){this.type=e.type||"string",this.pattern=e.pattern,this.message=e.message,this.required=e.required,this.default=e.default,this.description=e.description};if(o.info("watch: "+y+" kill: "+j+" process: "+process.pid),q&&(p=catrequire("cat.init"),p&&(_prompt.start(),l={properties:{name:new A({type:"string",pattern:/^[a-zA-Z0-9\-]+$/,message:"Name must be only letters, numbers or dashes",required:!0,description:"Enter the project name"}),host:new A({type:"string",required:!1,"default":"localhost",description:"Enter CAT server's host name"}),port:new A({type:"string",required:!1,"default":"8089",description:"Enter CAT server's port"}),protocol:new A({type:"string",required:!1,"default":"http",description:"Enter CAT server's protocol"})}},"example"===q?k="./../app":l.properties.appPath=new A({type:"string",required:!0,description:"Enter your project's (application) path"}),_prompt.get(l,function(e,t){t.appath||(t.appath=k),t.projectname=q,p.create(t)}))),j&&(1===j?(i=f.removeByKey("pid",process.pid),h.kill(i,[process.pid])):h.kill([j],[process.pid])),g){if(!v)throw o.warning(T[0]),T[0];_flow=catrequire("cat.flow"),_flow.init(),y&&(d=catrequire("cat.watch"),d.init()),e=n.load({path:v,emitter:u}),n.update({path:s.join(C.path,"resources")}),e&&g&&(m=a.load({project:e,grunt:c,emitter:u}),y||(w=0,t()))}}var c,l,v,q,y=!1,j=0,T=["[CAT] Project failed to load, No valid argument path was found"];i(),p()}}}();module.exports=function(){return CAT}();