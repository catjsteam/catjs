var _flow,_prompt=require("prompt"),_jsutils=require("js.utils"),_analytics=require("./analytics/analytics"),CAT=function(){function t(t,e){var r,i;t=t.toString(),t=t.toLowerCase(),m&&(r=m.externalConfig.project,i=r.getTask(t),i?(_flow.log({msg:[" > Open Task: ",JSON.stringify(i),"watch: "+(e?!0:!1)].join(" ")}),e&&m.watch(e),i.apply(m)):g.log("error","[CAT] No valid task named: '"+h+"', validate your cat's project configuration (catproject.json)"))}function e(r){l.on("task.done",function(){_flow.log({msg:[" Close Task: ",h[w]].join(" ")}),w++,w<h.length?(l.removeAllListeners("task.done"),e(r),y&&y.callback&&y.taskcb.call(this,h[w])):y&&y.callback&&y.callback.call(y)}),t(h[w],r)}var r,i,o,a,n,c,s,p,l,u,d,f,g,h,m,y,v,w=0;return function(){i=require("string-format"),c=require("path"),p=require("events"),l=new p.EventEmitter,u=function(t){return t&&t.home||{home:{path:"."}}}}(),v={init:function(t){var e,i,c=this;y=t,function(t){e=u(t),i=e.path,r=catrequire("cat.global"),o=r.log(),a=catrequire("cat.project"),n=catrequire("cat.config"),s=catrequire("cat.props"),g=catrequire("cat.utils"),r.set("home",e),f=catrequire("cat.cache"),f.set("pid",process.pid)}(t),s.init(function(e,r){return e?void o.error("[Properties] "+e):(global.CAT.props=r,void c.apply.call(c,t))})},watch:function(t){t&&(w=0,e(t))},apply:function(t){function i(){if(!t)return void 0;var e,i=r.get("home");i&&i.working&&(e=i.working.path),q=t.kill||q,k=t.watch||k,y="undefined"==typeof t.init?void 0:t.init||"cat",h=t.task,p=t.grunt,u=t,g=t.path||e,g&&o.debug("[CAT] Initial, current location: "+c.resolve(g)),o.debug("[CAT] Initial, command line arguments: "+JSON.stringify(t)),process.on("uncaughtException",function(t){console.error(t),process.exit(1)}),process.on("exit",function(){f.removeByKey("pid",process.pid)}),process.on("SIGINT",function(){process.exit(1)})}function s(){function i(e){e.appath||(e.appath=f),e.projectname=y,e.callback=t.callback,u.create(e)}var s,u,f,b=r.get("home"),C=t?t.schema:void 0,T=function(t){this.type=t.type||"string",this.pattern=t.pattern,this.message=t.message,this.required=t.required,this.default=t.default,this.description=t.description};if(o.info("watch: "+k+" kill: "+q+" process: "+process.pid),y&&(u=catrequire("cat.init"),u&&(C?_prompt=null:(_prompt.start(),C={properties:{name:new T({type:"string",pattern:/^[a-zA-Z0-9\-]+$/,message:"Name must be only letters, numbers or dashes",required:!0,description:"Enter the project name"}),host:new T({type:"string",required:!1,"default":"localhost",description:"Enter CAT server's host name"}),port:new T({type:"string",required:!1,"default":"8089",description:"Enter CAT server's port"}),protocol:new T({type:"string",required:!1,"default":"http",description:"Enter CAT server's protocol"}),analytics:new T({type:"string",required:!1,"default":"true",description:"Would you like to contribute analytics to CAT"})}}),"example"===y?f="./../app":C.properties.appath||(C.properties.appath=new T({type:"string",required:!0,description:"Enter your project's (application) path"})),_prompt?_prompt.get(C,function(t,e){i(e)}):i(C.properties))),v.kill(q),h){if(!g)throw o.warning(j[0]),j[0];_flow=catrequire("cat.flow"),_flow.init(),k&&(d=catrequire("cat.watch"),d.init()),s=a.load({path:g,emitter:l}),a.update({path:c.join(b.path,"resources")}),s&&(s.info.analytics&&"true"===s.info.analytics&&_analytics.updateAnalytics(global.catcommand),h&&(m=n.load({project:s,grunt:p,emitter:l}),k||(w=0,e())))}}var p,u,g,y,k=!1,q=-1,j=["[CAT] Project failed to load, No valid argument path was found"];i(),s()},kill:function(t){var e;void 0!==t&&null!==t&&-1!==t&&(1===t?(e=f.removeByKey("pid",process.pid),g.kill(e,[process.pid])):0===t?process&&process.exit(1):g.kill([t],[process.pid]),y&&y.callback&&y.callback.call(y))},getProject:function(){return m&&m.externalConfig?m.externalConfig.project:null}}};module.exports=CAT;