var _flow,_prompt=require("prompt"),_jsutils=require("js.utils"),CAT=function(){function e(e,t){var r,i;e=e.toString(),e=e.toLowerCase(),m&&(r=m.externalConfig.project,i=r.getTask(e),i?(_flow.log({msg:[" > Open Task: ",JSON.stringify(i),"watch: "+(t?!0:!1)].join(" ")}),t&&m.watch(t),i.apply(m)):h.log("error","[CAT] No valid task named: '"+g+"', validate your cat's project configuration (catproject.json)"))}function t(r){l.on("task.done",function(){_flow.log({msg:[" Close Task: ",g[k]].join(" ")}),k++,k<g.length?(l.removeAllListeners("task.done"),t(r),v&&v.callback&&v.taskcb.call(this,g[k])):v&&v.callback&&v.callback.call(v)}),e(g[k],r)}var r,i,o,n,a,c,p,s,l,u,d,f,h,g,m,v,w,k=0;return function(){i=require("string-format"),c=require("path"),s=require("events"),l=new s.EventEmitter,u=function(e){return e&&e.home||{home:{path:"."}}}}(),w={init:function(e){var t,i,c=this;v=e,function(e){t=u(e),i=t.path,r=catrequire("cat.global"),o=r.log(),n=catrequire("cat.project"),a=catrequire("cat.config"),p=catrequire("cat.props"),h=catrequire("cat.utils"),r.set("home",t),f=catrequire("cat.cache"),f.set("pid",process.pid)}(e),p.init(function(t,r){return t?void o.error("[Properties] "+t):(global.CAT.props=r,void c.apply.call(c,e))})},watch:function(e){e&&(k=0,t(e))},apply:function(e){function i(){if(!e)return void 0;var t,i=r.get("home");i&&i.working&&(t=i.working.path),y=e.kill||y,q=e.watch||q,v="undefined"==typeof e.init?void 0:e.init||"cat",g=e.task,s=e.grunt,u=e,h=e.path||t,h&&o.debug("[CAT] Initial, current location: "+c.resolve(h)),o.debug("[CAT] Initial, command line arguments: "+JSON.stringify(e)),process.on("uncaughtException",function(e){console.error(e),process.exit(1)}),process.on("exit",function(){f.removeByKey("pid",process.pid)}),process.on("SIGINT",function(){process.exit(1)})}function p(){function i(t){t.appath||(t.appath=f),t.projectname=v,t.callback=e.callback,u.create(t)}var p,u,f,C=r.get("home"),b=e?e.schema:void 0,T=function(e){this.type=e.type||"string",this.pattern=e.pattern,this.message=e.message,this.required=e.required,this.default=e.default,this.description=e.description};if(o.info("watch: "+q+" kill: "+y+" process: "+process.pid),v&&(u=catrequire("cat.init"),u&&(b?_prompt=null:(_prompt.start(),b={properties:{name:new T({type:"string",pattern:/^[a-zA-Z0-9\-]+$/,message:"Name must be only letters, numbers or dashes",required:!0,description:"Enter the project name"}),host:new T({type:"string",required:!1,"default":"localhost",description:"Enter CAT server's host name"}),port:new T({type:"string",required:!1,"default":"8089",description:"Enter CAT server's port"}),protocol:new T({type:"string",required:!1,"default":"http",description:"Enter CAT server's protocol"})}}),"example"===v?f="./../app":b.properties.appath||(b.properties.appath=new T({type:"string",required:!0,description:"Enter your project's (application) path"})),_prompt?_prompt.get(b,function(e,t){i(t)}):i(b.properties))),w.kill(y),g){if(!h)throw o.warning(j[0]),j[0];_flow=catrequire("cat.flow"),_flow.init(),q&&(d=catrequire("cat.watch"),d.init()),p=n.load({path:h,emitter:l}),n.update({path:c.join(C.path,"resources")}),p&&g&&(m=a.load({project:p,grunt:s,emitter:l}),q||(k=0,t()))}}var s,u,h,v,q=!1,y=-1,j=["[CAT] Project failed to load, No valid argument path was found"];i(),p()},kill:function(e){var t;void 0!==e&&null!==e&&-1!==e&&(1===e?(t=f.removeByKey("pid",process.pid),h.kill(t,[process.pid])):0===e?process&&process.exit(1):h.kill([e],[process.pid]),v&&v.callback&&v.callback.call(v))},getProject:function(){return m&&m.externalConfig?m.externalConfig.project:null}}};module.exports=CAT;