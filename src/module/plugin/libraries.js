var _catglobal=catrequire("cat.global"),_log=_catglobal.log(),_path=require("path"),_props=catrequire("cat.props"),_basePlugin=catrequire("cat.plugin.base"),_utils=catrequire("cat.utils"),_spawn=catrequire("cat.plugin.spawn"),_fs=require("fs.extra"),_typedas=require("typedas"),_bower=require("bower"),_jsutils=require("js.utils");module.exports=_basePlugin.ext(function(){function t(){this.concats={},this.names={},this.putName=function(t,n){this.names[t]=n},this.getName=function(t){return this.names[t]},this.add=function(t,n){this.concats[t]||(this.concats[t]=[]),this.concats[t].push(n)},this.get=function(t){return this.concats[t]},this.all=function(){var t,n=[];for(t in this.concats)this.concats.hasOwnProperty(t)&&n.push({key:t,value:this.get(t)});return n}}var n,a,e,i,s,r=this,o=new t;return{init:function(t){function c(){function t(t,a){function e(t){var n=_path.extname(t||"").split(".");return n[n.length-1]}var i,s,r,c,l="static-names"in d?d["static-names"]:void 0;try{a?(c=_typedas.isObject(a)&&"name"in a?a.name:a,n=t?_path.join(b,t,c):_path.join(b,c),i=_fs.readFileSync(n,"utf8"),i&&(s=e(n),r=_path.basename(n),s&&(o.add(s,i),_jsutils.Object.contains(l,r)&&o.putName(s,r)))):_log.warning(_props.get("cat.plugin.libraries.config.missing").format("[libraries ext]",d.name))}catch(u){_log.error(_props.get("cat.file.copy.failed").format("[libraries]",n,u))}}if(!_)return void _log.error(_props.get("cat.error.config.missing").format("[libraries ext]","lib"));var n,a=d[m];a&&_typedas.isArray(a)&&a.forEach(function(n){t(d.base||void 0,n)})}function l(){function t(){c(),l()}var a,e,i={},s=_path.join(_,q),r=!1;d=v[C],u&&d&&(r=_typedas.isArray(u)?_utils.contains(u,d.name):!0),b=d?_path.join(g,d.name):void 0;try{_fs.existsSync(x)&&_fs.existsSync(s)&&_utils.copySync(x,s)}catch(f){_log.error(_props.get("cat.file.copy.failed").format("[libraries]",s,f))}return i.install=function(){function e(n,a){function e(t){if(!t)return void 0;var n=t.src,a=t.type,e=t.path,i=t.name,o={_baseCopy:function(t){var n=t.src,a=t.path,e=t.name,i=t.content;n?(n=_utils.globmatch({src:n}),n.forEach(function(t){t&&_utils.copySync(t,_path.join(a,e))})):i&&_fs.writeFileSync(_path.join(a,e),i)},json:function(t){var n=("parse"in t?t.parse:void 0,"src"in t&&t.src),a=t.path,e=t.name;n&&(n=_utils.globmatch({src:n}),n.forEach(function(t){var n;t&&(n=_fs.readFileSync(t,"utf8"),n&&o._baseCopy({content:n,name:e,path:a}))}))},css:function(t){o._baseCopy(t)},js:function(t){var n=t.src,a=t.path,e=t.name;s.dev({src:n,out:{name:e,path:a},jshint:{opt:{evil:!0,strict:!1,curly:!0,eqeqeq:!0,immed:!1,latedef:!0,newcap:!1,noarg:!0,sub:!0,undef:!0,boss:!0,eqnull:!0,node:!0,es5:!1},globals:{XMLHttpRequest:!0,document:!0,_cat:!0,$:!0,Ext:!0,window:!0,chai:!0,phantom:!0}}})}};n&&a&&e&&i||_log.error("[CAT libraries install] Not valid argument(s) 'src' / 'type' / 'path' / 'name' "),r=[],n.forEach(function(t){r.push(_path.join(b,t))}),t.src=r,o[a].call(this,t)}var i,s=_jsutils.Task,r=[],o=d.base;a in d&&d[a]&&(i=d[a],o=_path.join(b,o),o&&(_fs.existsSync(o)||_fs.mkdirpSync(o)),_typedas.isArray(i)?(i.forEach(function(t){t.path=o,e(t)}),t()):_log.error("[CAT libraries install] library's dev property should be of 'Array' type"))}var i={cwd:g};"static"===d.install?t():"internal"===d.install?e(d,"dev"):"bower"===d.install&&(_utils.isWindows()?(a=_spawn().spawn({command:"bowerutils.bat",args:["install",d.name],options:i,emitter:n}),a.on("close",function(n){0!==n?_log.info("[spawn close] exited with code "+n):(_log.info("[bower] library "+d.name+" Installed"),t())})):_bower.commands.install([d.name],{},i).on("end",function(){_log.info("[bower] library "+d.name+" Installed"),t()}))},i.clean=function(){var t=d.base;"internal"===d.install?(t=_path.join(b,t),_utils.deleteSync(t),l()):"bower"===d.install&&(_utils.deleteSync(_path.join(g,d.name)),l())},i.build=function(){t()},C++,C>v.length?(_fs.existsSync(_)||_fs.mkdirSync(_),e=o.all(),e.forEach(function(t){var n,a,e,i,s=!0;t&&t.value.length>0&&(a=_,i=o.getName(t.key),n=t.value.join(""),e=i?i:[h,".",t.key].join(""),"json"===t.key&&s&&(n=_jsutils.Template.template({content:n,data:{project:j}})),_fs.writeFileSync(_path.join(a,e),n))}),void(n&&n.emit("job.done",{status:"done"}))):void(r&&i[p]?i[p].call(this):l())}var u,p,f,_,h,d,m,g,b,y,v,j=t.internalConfig?t.internalConfig.getProject():void 0,w=!1,S=["[libraries plugin] No valid configuration"],q="manifest.json",x=_path.join(global.catlibs,q),C=0;_fs.existsSync(x)&&(y=_fs.readFileSync(x,"utf8")),t||(_log.error(S[1]),r.setDisabled(!0)),n=t.emitter,a=t.global,e=t.data,i=t.internalConfig,s=i?i.getProject():void 0,r.dataInit(e),f=e.data,u=f.imports||"*",p=f.action,w="true"===f.wipe?!0:!1,t&&f&&y&&(y=JSON.parse(y),v=y.libraries,m=y.mode,s&&(_=y.out.folder,h=y.out.name,g=_path.join(cathome,s.getInfo("libraries").path)),v&&_typedas.isArray(v)&&v.length>0&&l())},validate:function(){return{dependencies:["manager"]}}}});