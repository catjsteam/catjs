var _catglobal=catrequire("cat.global"),_log=_catglobal.log(),_path=require("path"),_props=catrequire("cat.props"),_basePlugin=catrequire("cat.plugin.base"),_utils=catrequire("cat.utils"),_spawn=catrequire("cat.plugin.spawn"),_fs=require("fs.extra"),_typedas=require("typedas"),_bower=require("bower"),_jsutils=require("js.utils");module.exports=_basePlugin.ext(function(){function t(){this.concats={},this.names={},this.putName=function(t,n){this.names[t]=n},this.getName=function(t){return this.names[t]},this.add=function(t,n){this.concats[t]||(this.concats[t]=[]),this.concats[t].push(n)},this.get=function(t){return this.concats[t]},this.all=function(){var t,n=[];for(t in this.concats)this.concats.hasOwnProperty(t)&&n.push({key:t,value:this.get(t)});return n}}var n,e,a,i,s,r=this,o=new t;return{init:function(t){function c(){function t(t,e){function a(t){var n=_path.extname(t||"").split(".");return n[n.length-1]}var i,s,r,c,l="static-names"in m?m["static-names"]:void 0;try{e?(c=_typedas.isObject(e)&&"name"in e?e.name:e,n=t?_path.join(b,t,c):_path.join(b,c),i=_fs.readFileSync(n,"utf8"),i&&(s=a(n),r=_path.basename(n),s&&(o.add(s,i),_jsutils.Object.contains(l,r)&&o.putName(s,r)))):_log.warning(_props.get("cat.plugin.libraries.config.missing").format("[libraries ext]",m.name))}catch(u){_log.error(_props.get("cat.file.copy.failed").format("[libraries]",n,u))}}if(!_)return void _log.error(_props.get("cat.error.config.missing").format("[libraries ext]","lib"));var n,e=m[g];e&&_typedas.isArray(e)&&e.forEach(function(n){t(m.base||void 0,n)})}function l(){function t(){c(),l()}var e,a,i={},s=_path.join(_,x),r=!1;m=j[C],u&&m&&(r=_typedas.isArray(u)?_utils.contains(u,m.name):!0),b=m?_path.join(y,m.name):void 0;try{_fs.existsSync(k)&&_fs.existsSync(s)&&_utils.copySync(k,s)}catch(f){_log.error(_props.get("cat.file.copy.failed").format("[libraries]",s,f))}return i.install=function(){function a(n,e){function a(t){if(!t)return void 0;var n=t.src,e=t.type,a=t.path,i=t.name,o={_baseCopy:function(t){var n=t.src,e=t.path,a=t.name,i=t.content;n?(n=_utils.globmatch({src:n}),n.forEach(function(t){t&&_utils.copySync(t,_path.join(e,a))})):i&&_fs.writeFileSync(_path.join(e,a),i)},json:function(t){var n=("parse"in t?t.parse:void 0,"src"in t&&t.src),e=t.path,a=t.name;n&&(n=_utils.globmatch({src:n}),n.forEach(function(t){var n;t&&(n=_fs.readFileSync(t,"utf8"),n&&o._baseCopy({content:n,name:a,path:e}))}))},css:function(t){o._baseCopy(t)},js:function(t){var n=t.src,e=t.path,a=t.name;s.dev({src:n,out:{name:a,path:e},jshint:{opt:{evil:!0,strict:!1,curly:!0,eqeqeq:!0,immed:!1,latedef:!0,newcap:!1,noarg:!0,sub:!0,undef:!0,boss:!0,eqnull:!0,node:!0,es5:!1},globals:{XMLHttpRequest:!0,document:!0,_cat:!0,$:!0,Ext:!0,window:!0,chai:!0,phantom:!0}}})}};n&&e&&a&&i||_log.error("[CAT libraries install] Not valid argument(s) 'src' / 'type' / 'path' / 'name' "),r=[],n.forEach(function(t){r.push(_path.join(b,t))}),t.src=r,o[e].call(this,t)}var i,s=_jsutils.Task,r=[],o=m.base;e in m&&m[e]&&(i=m[e],o=_path.join(b,o),o&&(_fs.existsSync(o)||_fs.mkdirpSync(o)),_typedas.isArray(i)?(i.forEach(function(t){t.path=o,a(t)}),t()):_log.error("[CAT libraries install] library's dev property should be of 'Array' type"))}var i={cwd:y};"static"===m.install?t():"internal"===m.install?a(m,"dev"):"bower"===m.install&&(_utils.isWindows()?(e=_spawn().spawn({command:"bowerutils.bat",args:["install",m.name],options:i,emitter:n}),e.on("close",function(n){0!==n?_log.info("[spawn close] exited with code "+n):(_log.info("[bower] library "+m.name+" Installed"),t())})):_bower.commands.install([m.name],{},i).on("end",function(){_log.info("[bower] library "+m.name+" Installed"),t()}))},i.clean=function(){var t=m.base;"internal"===m.install?(t=_path.join(b,t),_utils.deleteSync(t),l()):"bower"===m.install&&(_utils.deleteSync(_path.join(y,m.name)),l())},i.build=function(){t()},C++,C>j.length?(_fs.existsSync(_)||_fs.mkdirSync(_),a=o.all(),a.forEach(function(t){var n,e,a,i,s,r=!0;t&&t.value.length>0&&(e=_,i=o.getName(t.key),n=t.value.join(""),a=i?i:[d,".",t.key].join(""),"json"===t.key&&r&&(n=_jsutils.Template.template({content:n,data:{project:w}})),"json"!==t.key?_fs.writeFileSync(_path.join(e,a),n):(s=_path.join(h,"/config/",a),"json"!==t.key||_fs.existsSync(s)||_fs.writeFileSync(s,n)))}),void(n&&n.emit("job.done",{status:"done"}))):void(r&&i[p]?i[p].call(this):l())}var u,p,f,_,h,d,m,g,y,b,v,j,w=t.internalConfig?t.internalConfig.getProject():void 0,S=!1,q=["[libraries plugin] No valid configuration"],x="manifest.json",k=_path.join(global.catlibs,x),C=0;_fs.existsSync(k)&&(v=_fs.readFileSync(k,"utf8")),t||(_log.error(q[1]),r.setDisabled(!0)),n=t.emitter,e=t.global,a=t.data,i=t.internalConfig,s=i?i.getProject():void 0,r.dataInit(a),f=a.data,u=f.imports||"*",p=f.action,S="true"===f.wipe?!0:!1,t&&f&&v&&(v=JSON.parse(v),j=v.libraries,g=v.mode,s&&(h=s.getInfo("source"),_=v.out.folder,d=v.out.name,y=_path.join(cathome,s.getInfo("libraries").path)),j&&_typedas.isArray(j)&&j.length>0&&l())},validate:function(){return{dependencies:["manager"]}}}});