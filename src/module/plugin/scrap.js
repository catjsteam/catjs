var _log=catrequire("cat.global").log(),_path=require("path"),_utils=catrequire("cat.utils"),_Scrap=catrequire("cat.common.scrap"),_parser=catrequire("cat.common.parser"),_typedas=require("typedas"),_basePlugin=catrequire("cat.plugin.base"),_props=catrequire("cat.props");module.exports=_basePlugin.ext(function(){function e(e){var t,a,i,r=0,n=[];if(e&&_typedas.isArray(e))for(t=e.length;t>r;r++)a=e[r],a&&(i=_Scrap.extractScrapBlock(a),i&&i.length>0&&(n=n.concat(i)));return n}function t(e,t){t||l--,2===c&&0===l&&r.emit("job.wait",{status:"done"})}var a,i,r,n,s=this,o={},c=0,l=0;return n={done:function(){r.removeListener("scan.init",n.initListener),r.removeListener("scan.file",n.file),r.removeListener("scan.done",n.done),c?c=2:r.emit("job.wait",{status:"done"}),t(null,!0)},file:function(t){2!==c&&(c=1),l++;var i=t,n=s.getFilters();return s.isDisabled()?void r.emit("job.scrap.wait",{status:"wait"}):void(t&&(i=_utils.getRelativePath(t,a),s.applyFileExtFilters(n,t)?r.emit("job.scrap.wait",{status:"wait"}):(o.Comment||(o.Comment=_parser.get("Comment")),o.Comment.parse({file:t,callback:function(i){var n,s,o,c=[],l=0,p=0;if(i&&_typedas.isArray(i)&&(o=e(i),o&&_typedas.isArray(o)&&o.length>0)){for(l=o.length,p=0;l>p;p++)n=o[p],s=_Scrap.create({file:t,scrapComment:n}),s&&(c.push(s),_Scrap.apply({basePath:a,scraps:[s],apply:!1}));_Scrap.normalize(c)}r.emit("job.scrap.wait",{status:"wait"})}}))))},folder:function(){},getListeners:function(e){return s.isDisabled()?void 0:r.listeners(e)},initListener:function(e){a=e?e.path:void 0,a||_utils.error("[Scrap Plugin] No valid base path")},init:function(e){var a=["[Scrap plugin] scrap operation disabled, No valid configuration"];e||(_log.error(a[1]),s.setDisabled(!0)),r=e.emitter,i=e.global,r?(r.removeListener("job.scrap.wait",t),r.on("scan.init",n.initListener),r.on("scan.done",n.done),r.on("scan.file",n.file),r.on("job.scrap.wait",t),2!==c&&(c=0)):_log.warning("[Scrap plugin] No valid emitter, failed to assign listeners")},getType:function(){return"scrap"},validate:function(){return{dependencies:["scan"]}}}});