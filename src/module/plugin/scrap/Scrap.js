var _utils=catrequire("cat.utils"),_regutils=catrequire("cat.regexp.utils"),_props=catrequire("cat.props"),_md=catrequire("cat.mdata"),_typedas=require("typedas"),_log=catrequire("cat.global").log(),_clazz=require("./ScrapItem.js"),_parser=require("./parser/Parser.js"),_scrapEnum=require("./ScrapEnum.js"),_commonparser=require("./parser/CommonParser.js"),_ScrapConfigItem=require("./ScrapConfigItem.js"),_scrapUtils=require("./ScrapUtils.js");module.exports=function(){var e,r=["name"],t=[],a=function(e){return _parser.parse(e)};return{getEnum:function(e){return _scrapEnum.getScrapEnum(e)},clazz:_clazz,add:function(e){e||_utils.error(_props.get("cat.error.config").format("[Scrap Entity]"));var t=e.name,a=e.func,i=e.single,n=e.singleton;r.push(t),_clazz.prototype[t+"Init"]=function(){void 0!==i&&this.setSingle(t,i),void 0!==n&&this.setSingleton(t,n)},_clazz.prototype[t+"Apply"]=function(e){return a.call(this,e)}},create:function(e){var r,a,i,n={};if(e&&(r=e.scrapComment,r&&(_scrapEnum.getScrapEnum("scrapinfo",n),n.start=r.start,n.end=r.end,i=r.comment),a=e.file),!r||r&&r.rows&&!_typedas.isArray(r.rows))return void 0;for(var s,c,l,o,p,u,f,g,m,_,d,h,z=r.rows,S=1,v=z.length,j={},y="@@(.*)([\\[]+)(.*)([\\s].*)",E="(.*)?([\\]])([\\s]?.*)",q="@@(.*)([\\[]+)(.*)([\\]]+.*?)([\\s]?.*)",C=0,U=0;v-1>S;S++)if(u=null,m=null,C=0,U=0,s=z[S])if(f&&(p=_regutils.getMatch(s,E)),f&&!p)f.push(s);else if(p||f||(u=_regutils.getMatch(s,"@@(.*?\\[[\\s]+)(.*)"),u=u?null:_regutils.getMatch(s,"@@(.*?[\\s]+)(.*)")),u)l=u[1],o=u[2],_=_commonparser.parseName(l),_?(h&&(l=_.name),d=_.sign,h=_.hint):d=void 0,_scrapUtils.putScrapConfig(j,l,_ScrapConfigItem.create({value:o,sign:d,hint:h}));else if(p||f||(g=_regutils.getMatch(s+" ",q),f=_regutils.getMatch(s+" ",y)),g?(l=g[1],m=_scrapUtils.collectDataConfig(g)):f&&p&&(f=f.concat(_scrapUtils.normalizeData(p)),l=f[1],m=_scrapUtils.collectDataConfig(f)),m){try{m=_scrapUtils.cleanArray(m),m=_scrapUtils.parseData(m),m&&(o=m?JSON.parse(m.join("")):void 0,_scrapUtils.putScrapConfig(j,l,o))}catch(b){console.log(b)}p=null,g=null,f=null}return j.file=a,j.file&&(j.file=j.file.split("\\").join("/"),j.file=j.file.split("//").join("/")),j.scrapinfo=n,j.commentinfo=i,j.name?(c=new _clazz(j),c&&t.push(c),c):void _utils.log("error",_props.get("cat.error.scrap.property.required").format("[scrap entity]","name"))},normalize:function(e){var r={files:{}};e&&(e.forEach(function(e){var t;e&&(t=e.get("file"),t&&(r.files[t]||(r.files[t]={}),r.files[t][e.get("name")]=e.serialize()))}),_md.normalize(r))},apply:function(e){function a(e){e&&(p&&(e.buildContext(r),e.apply()),i=e.get("file"),l.files[i]||(s=l.files,s[i]={}),s[i][e.get("name")]=e.serialize())}var i,n,s,c,l={files:{},project:{}},o={files:l.files,project:l.project},p=!0;e&&(n=e.scraps||t,e.basePath?(c=e.basePath,l.project.basepath=c):delete o.project),n.forEach(function(e){a(e)}),_md.update(o)},get:function(e){return new _clazz({id:e})},getScrapEnum:function(){return _scrapEnum.scrapEnum},getScraps:function(){return t},getScrap:function(r){return!e&&t&&(e={},t.forEach(function(r){r&&(e[r.id()]=r)})),e[r]},extractScrapBlock:a}}();